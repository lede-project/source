diff --git a/arch/mips/pci/pci-lantiq.c b/arch/mips/pci/pci-lantiq.c
index 6a15dbd..c10ca7d 100644
--- a/arch/mips/pci/pci-lantiq.c
+++ b/arch/mips/pci/pci-lantiq.c
@@ -62,6 +62,8 @@
 #define ltq_pci_cfg_w32(x, y)	ltq_w32((x), ltq_pci_mapped_cfg + (y))
 #define ltq_pci_cfg_r32(x)	ltq_r32(ltq_pci_mapped_cfg + (x))
 
+extern u32 max_low_pfn;
+
 __iomem void *ltq_pci_mapped_cfg;
 static __iomem void *ltq_pci_membase;
 
@@ -82,13 +84,24 @@ static struct pci_controller pci_controller = {
 	.io_offset	= 0x00000000UL,
 };
 
+static u32 round_up_to_next_power_of_two(u32 x)
+{
+    x--;
+    x |= x >> 1;
+    x |= x >> 2;
+    x |= x >> 4;
+    x |= x >> 8;
+    x |= x >> 16;
+    x++;
+    return x;
+}
+
 static inline u32 ltq_calc_bar11mask(void)
 {
 	u32 mem, bar11mask;
 
 	/* BAR11MASK value depends on available memory on system. */
-	mem = get_num_physpages() * PAGE_SIZE;
-	bar11mask = (0x0ffffff0 & ~((1 << (fls(mem) - 1)) - 1)) | 8;
+	bar11mask =((-round_up_to_next_power_of_two((max_low_pfn << PAGE_SHIFT))) & 0x0F000000) | 8;
 
 	return bar11mask;
 }
